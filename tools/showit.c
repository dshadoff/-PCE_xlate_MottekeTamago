/*****************************************************************************/
/* showit.c                                                                  */
/* Template for coding decoder modules for TMod2                             */
/* (c) 2000 Jay                                                              */
/*****************************************************************************/
#include "stdio.h"

#define MATCH_SIZE	3

FILE * inp;
unsigned char buff[937984];
unsigned char srch[] = { 0xa0, 0xaf, 0x9a };

unsigned char table1[] = {
	0,0,0,0, 0,0x20,0,0, 0,0,0,0, 0x20,0,0,0,
	0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,

	0x20,0x81,0x81,0x81, 0x81,0x81,0x81,0x81, 0x81,0x81,0x81,0x81, 0x81,0x81,0x81,0x81,	/* 0x20 */

	0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x81,0x81, 0x81,0x81,0x81,0x81,	/* 0x30 */
	0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82,	/* 0x40 */
	0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82,	/* 0x50 */
	0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82,	/* 0x60 */
	0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82,	/* 0x70 */

	0x20,0x81,0x81,0x81, 0x81,0x81,0x83,0x83, 0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83,	/* 0x80 */
	0x81,0x83,0x83,0x83, 0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83,	/* 0x90 */
	0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83,	/* 0xa0 */
	0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83, 0x83,0x83,0x83,0x83, 0x83,0x83,0x81,0x81,	/* 0xb0 */

	0x20,0x81,0x81,0x81, 0x81,0x81,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82,	/* 0xc0 */
	0x81,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82,	/* 0xd0 */
	0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82,	/* 0xe0 */
	0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x82,0x82, 0x82,0x82,0x81,0x81	/* 0xf0 */

};

unsigned char table2[] = {
	0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,
	0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0,

	0   ,0x49,0x8d,0x94, 0x90,0x93,0x95,0x8c, 0x69,0x6a,0x96,0x7b, 0x43,0x7c,0x44,0x5e,	/* 0x20 */

	0x4f,0x50,0x51,0x52, 0x53,0x54,0x55,0x56, 0x57,0x58,0x46,0x47, 0x83,0x81,0x84,0x48,	/* 0x30 - ASCII */
	0x5f,0x60,0x61,0x62, 0x63,0x64,0x65,0x66, 0x67,0x68,0x69,0x6a, 0x6b,0x6c,0x6d,0x6e,	/* 0x40 */
	0x6f,0x70,0x71,0x72, 0x73,0x74,0x75,0x76, 0x77,0x78,0x79,0x7a, 0x7b,0x7c,0x7d,0x7e,	/* 0x50 */
	0x7f,0x80,0x81,0x82, 0x83,0x84,0x85,0x86, 0x87,0x88,0x89,0x8a, 0x8b,0x8c,0x8d,0x8e,	/* 0x60 */
	0x8f,0x90,0x91,0x92, 0x93,0x94,0x95,0x96, 0x97,0x98,0x99,0x9a, 0x9b,0x9c,0x9d,0x9e,	/* 0x70 */

	0   ,0x42,0x75,0x76, 0x41,0x45,0x92,0x40, 0x42,0x44,0x46,0x48, 0x83,0x85,0x87,0x62,	/* 0x80 */
	0x5b,0x41,0x43,0x45, 0x47,0x49,0x4a,0x4c, 0x4e,0x50,0x52,0x54, 0x56,0x58,0x5a,0x5c,	/* 0x90 */
	0x5e,0x60,0x63,0x65, 0x67,0x69,0x6a,0x6b, 0x6c,0x6d,0x6e,0x71, 0x74,0x77,0x7a,0x7d,	/* 0xa0 */
	0x7e,0x80,0x81,0x82, 0x84,0x86,0x88,0x89, 0x8a,0x8b,0x8c,0x8d, 0x8f,0x93,0x4a,0x4b,	/* 0xb0 */
		
	0   ,0x42,0x75,0x76, 0x41,0x45,0xf0,0x9f, 0xa1,0xa3,0xa5,0xa7, 0xe1,0xe3,0xe5,0xc1,	/* 0xc0 */
	0x5b,0xa0,0xa2,0xa4, 0xa6,0xa8,0xa9,0xab, 0xad,0xaf,0xb1,0xb3, 0xb5,0xb7,0xb9,0xbb,	/* 0xd0 */
	0xbd,0xbf,0xc2,0xc4, 0xc6,0xc8,0xc9,0xca, 0xcb,0xcc,0xcd,0xd0, 0xd3,0xd6,0xd9,0xdc,	/* 0xe0 */
	0xdd,0xde,0xdf,0xe0, 0xe2,0xe4,0xe6,0xe7, 0xe8,0xe9,0xea,0xeb, 0xed,0xf1,0x4a,0x4b	/* 0xf0 */
};


int atohex(char * in)
{
int output;
char * p;
char temp;

    output = 0;
    p = in;
    while (*p != '\0')
    {
        temp = *p;
        if ((temp >= 'a') && (temp <= 'f')) temp = temp - 'a' + 10;
        if ((temp >= 'A') && (temp <= 'F')) temp = temp - 'A' + 10;
        if ((temp >= '0') && (temp <= '9')) temp = temp - '0';
        if ((temp < 0) || (temp > 15)) break;

        output *= 16;
        output += (int)temp;
        p++;
    }
    return(output);
}


int main(int argc, char * argv[])
{
int i, j, j1, c, len, diff, dummy, match;
long int startat, temp1, temp2;
char *p;

   inp = fopen("track2.bin", "rb");

   if (inp == NULL) {
      printf("failed to open\n");
      exit(1);
   }

   i = 0;
   dummy = 0;

   while (!feof(inp))
   {
      dummy = fread(&buff[i++], 1, 1, inp);
   }

   len = i;
   fprintf(stderr, "size of file = %ld\n\n", len);

   startat = atohex(argv[1]);
   len = atohex(argv[2]);

   fprintf(stderr, "start at = 0x%6.6x minus 30\n", startat);
   fprintf(stderr, "end at   = 0x%6.6x plus 30\n", (startat+len*2));

   startat -= 60;
   len += 30;

   if (buff[startat] == 0x01) startat++;

   for (i = 0; i < len; i++)
   {
      j  = buff[startat+(i*2)];
      j1 = buff[startat+(i*2)-60];	/* search for modifiers */

      temp1 = table1[j];
      temp2 = table2[j];

      if (temp1 <= 0x20)
      {
         fprintf(stdout, "%c%c", 0x81, 0x40);
      }
      else if (temp1 <= 0x80)
      {
         fprintf(stdout, "%c", temp1);
      }
      else
      {
         if ((j1 == 0xbe) || (j1 == 0xfe)) temp2++;
         if ((j1 == 0xbf) || (j1 == 0xff)) temp2 += 2;

         fprintf(stdout, "%c", temp1);
         fprintf(stdout, "%c", temp2);
      }
      if ((i % 30) == 29) fprintf(stdout, "\n");
   }

}
